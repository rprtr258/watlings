name: Exercises CI

on:
  push:
    branches: ["*"]

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run typecheck
        run: |
          bun ci
          bun run tsc -p tsconfig.json

          cd web-build
          bun ci
          bun run generate
          bun run tsc -p tsconfig.json

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun ci

      - name: Install wasm-tools
        run: |
          wget https://github.com/bytecodealliance/wasm-tools/releases/download/v1.245.1/wasm-tools-1.245.1-x86_64-linux.tar.gz -O wasm-tools.tar.gz
          tar xzf wasm-tools.tar.gz
          sudo mv wasm-tools-*-x86_64-linux/wasm-tools /usr/local/bin/wasm-tools

      - name: Verify exercises fail before patch and pass after
        run: bun run ci:check
